# Upbound Builder - AWS IAM

This folder has Crossplane compositions for using the upbound builder for AWS IAM.

## Compositions

Each composition has four labels to determine which on is used.
- builder [iam]
- cloud [aws, gcp, azure]
- service [see Service column in the table below]
- config [see Config column in the table below]

All compositions must have the following passed in from their claim:
- spec.compositionSelector.matchLabels.iam
- spec.compositionSelector.matchLabels.cloud
- spec.compositionSelector.matchLabels.service
- spec.compositionSelector.matchLabels.config
- spec.name [name of the item to be created]
- spec.resourceConfig.providerConfigName *Crossplane Provider config
- spec.resourceConfig.deletionPolicy

See "Required Inputs" in the table below for additional inputs for specific compositions.

## AWS Configurations List

Below is a list of AWS configurations. There are three types of AWS policies:

* [Identity-Based](#Identity-Based): Policies that are assigned to an identity (user, group, or role)
* [Resource-Based](#Resource-Based): Policies assigned directly to a service (i.e - S3)
* [Resource-Level-Based](#Resource-Level-Based): Use ARNs to specify individual resources within the policy

### Identity-Based

| Composition                                                                     | Service  | Config                                    | Description                                                                                                                                                                                     | Policy                                                                                                                                                                                                                                                                                                       | Required Inputs                                                                                                                                                                                                                                                          | Outputs                                   | Example                                                                                     |
|---------------------------------------------------------------------------------|----------|-------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|---------------------------------------------------------------------------------------------|
| <h4>role-exists-crud.dynamodb.aws.iam.builder.upbound.io</h4>                   | dynamodb | role-exists-crud                          | Crud dynamodb policy and assigns it to an existing role                                                                                                                                         | <ul><li>Allow<ul><li>dynamodb:BatchGetItem</li><li>dynamodb:BatchWriteItem</li><li>dynamodb:DescribeStream</li><li>dynamodb:DescribeTable</li><li>dynamodb:Query</li><li>dynamodb:Scan</li><li>dynamodb:Get*</li><li>dynamodb:DeleteItem</li><li>dynamodb:UpdateItem</li><li>dynamodb:PutItem</li></ul></ul> | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [table arn]</li><li>spec.builderConfig.cloudParameters.iam.aws.principal [role]</li></ul>                                                                                                                 |                                           | [dynamodb-role-exists-crud.yaml](../../../examples/iam/aws/dynamodb-role-exists-crud.yaml)  |
| <h4>basic-server-nodes.eks.aws.iam.builder.upbound.io</h4>                      | eks      | basic-server-nodes                        | Create basic eks policy for api server and nodes assigned to cluster name given                                                                                                                 | <ul><li>Managed<ul><li>AmazonEKSClusterPolicy</li><li>AmazonEKSWorkerNodePolicy</li><li>AmazonEKS_CNI_Policy</li><li>AmazonEC2ContainerRegistryReadOnly</li></ul></ul>                                                                                                                                       |                                                                                                                                                                                                                                                                          |                                           | [eks-basic-server-nodes.yaml](../../../examples/iam/aws/eks-basic-server-nodes.yaml)        |
| <h4>irsa-efs.eks.aws.iam.builder.upbound.io</h4>                                | eks      | irsa-efs                                  | Create a new role, policy and policy attachment for irsa eks setup with efs                                                                                                                     | <ul><li>Allow<ul><li>elasticfilesystem:DescribeAccessPoints</li><li>elasticfilesystem:DescribeAccessPoints</li><li>elasticfilesystem:DescribeAccessPoints</li><li>elasticfilesystem:DescribeAccessPoints</li></ul></ul>                                                                                      | <ul><li>spec.cloudParameters.generic.oidcArn</li><li>spec.cloudParameters.generic.oidcHost</li><li>spec.cloudParameters.generic.condition</li><li>spec.cloudParameters.generic.serviceAccountNamespace</li><li>spec.cloudParameters.generic.serviceAccountName</li></ul> | <ul><li>status.builder.roleArn</li></ul>  | [eks-irsa-efs.yaml](../../../examples/iam/aws/eks-irsa-efs.yaml)                            |
| <h4>group-crud.s3.aws.iam.builder.upbound.io</h4>                               | s3       | group-crud                                | Create crud policy for a bucket and assign it to a group.                                                                                                                                       | <ul><li>Allow<ul><li>s3:ListAllMyBuckets</li><li>s3:ListBucket</li><li>s3:GetBucketLocation</li><li>s3:PutObject</li><li>s3:GetObject</li><li>s3:DeleteObject</li></ul></ul>                                                                                                                                 | <ul><li>spec.builderConfig.cloudParameters.iam.aws.principal [group]</li></ul>                                                                                                                                                                                           |                                           | [s3-group-crud.yaml](../../../examples/iam/aws/s3-group-crud.yaml)                          |
| <h4>loki-role.s3.aws.iam.builder.upbound.io</h4>                                | s3       | loki-role                                 | Create s3 policy needed for loki.                                                                                                                                                               | <ul><li>Allow<ul><li>s3:ListObjects</li><li>s3:ListBucket</li><li>s3:PutObject</li><li>s3:DeleteObject</li><li>s3:GetObject</li></ul></ul>                                                                                                                                                                   | <ul><li>spec.builderConfig.cloudParameters.iam.aws.principal[]</li><li>spec.cloudParameters.generic.clusterOIDC [OIDC]</li><li>spec.cloudParameters.generic.saName [service account name]</li></ul>                                                                      | <ul><li>status.builder.roleArn</li></ul>  | [s3-loki-role.yaml](../../../examples/iam/aws/s3-loki-role.yaml)                            |
| <h4>role-new-crud.s3.aws.iam.builder.upbound.io</h4>                            | s3       | role-new-crud                             | Create a new role, policy and policy attachment. The policy will give CRUD access to the role.                                                                                                  | <ul><li>Allow<ul><li>s3:ListAllMyBuckets</li><li>s3:ListBucket</li><li>s3:GetBucketLocation</li><li>s3:PutObject</li><li>s3:GetObject</li><li>s3:DeleteObject</li></ul></ul>                                                                                                                                 | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [bucket arn]</li></ul>                                                                                                                                                                                    | <ul><li>status.builder.roleArn</li></ul>  | [s3-role-new-crud.yaml](../../../examples/iam/aws/s3-role-new-crud.yaml)                    |
| <h4>role-new-crud-acl.s3.aws.iam.builder.upbound.io</h4>                        | s3       | role-new-crud-acl                         | Create a new role, policy and policy attachment including ACL. The policy will give CRUD access to the role                                                                                     | <ul><li>Allow<ul><li>s3:ListAllMyBuckets</li><li>s3:ListBucket</li><li>s3:GetBucketLocation</li><li>s3:PutObject</li><li>s3:PutObjectAcl</li><li>s3:GetObject</li><li>s3:GetObjectVersion</li><li>s3:GetObjectAcl</li><li>s3:DeleteObject</li></ul></ul>                                                     | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [bucket arn]</li></ul>                                                                                                                                                                                    | <ul><li>status.builder.roleArn</li></ul>  | [s3-role-new-crud.yaml](../../../examples/iam/aws/s3-role-new-crud.yaml)                    |
| <h4>role-new-crud-multipart.s3.aws.iam.builder.upbound.io</h4>                  | s3       | role-new-crud-multipart                   | Create a new role, policy and policy attachment. The policy will give CRUD access to the role to include multi-part uploads                                                                     | <ul><li>Allow<ul><li>s3:ListAllMyBuckets</li><li>s3:ListBucket</li><li>s3:GetBucketLocation</li><li>s3:PutObject</li><li>s3:GetObject</li><li>s3:DeleteObject</li></ul></ul>                                                                                                                                 | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [bucket arn]</li></ul>                                                                                                                                                                                    | <ul><li>status.builder.roleArn</li></ul>  |                                                                                             |
| <h4>role-new-min-udl-multipart.s3.aws.iam.builder.upbound.io</h4>               | s3       | role-new-min-udl-multipart                | Create a new role, policy and policy attachment. The policy will give minimum permissions to upload, download and list (udl) capabilities for a bucket including multipart                      | <ul><li>Allow<ul><li>s3:ListAllMyBuckets</li><li>s3:ListBucket</li><li>s3:GetBucketLocation</li><li>s3:PutObject</li><li>s3:GetObject</li><li>s3:DeleteObject</li></ul></ul>                                                                                                                                 | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [bucket arn]</li></ul>                                                                                                                                                                                    | <ul><li>status.builder.roleArn</li></ul>  |                                                                                             |
| <h4>role-new-min-udl-multipart-single-folder.s3.aws.iam.builder.upbound.io</h4> | s3       | role-new-min-udl-multipart-single-folder  | Create a new role, policy and policy attachment. The policy will give minimum permissions to upload, download and list (udl) capabilities for a single folder in a bucket including multipart.  | <ul><li>Allow<ul><li>s3:GetObject</li><li>s3:PutObject</li><li>s3:DeleteObject</li><li>s3:ListMultipartUploadParts</li><li>s3:AbortMultipartUpload</li><li>s3:GetBucketLocation</li><li>s3:ListBucket</li><li>s3:ListBucketMultipartUploads</li></ul></ul>                                                   | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [bucket arn]</li><li>spec.builderConfig.cloudParameters.generic.folder [folder name]</li></ul>                                                                                                            |                                           |                                                                                             |
| <h4>role-exists-crud.s3.aws.iam.builder.upbound.io</h4>                         | s3       | role-exists-crud                          | Create a CRUD policy with and assigns it to the passed in role.                                                                                                                                 | <ul><li>Allow<ul><li>s3:ListAllMyBuckets</li><li>s3:ListBucket</li><li>s3:GetBucketLocation</li><li>s3:PutObject</li><li>s3:GetObject</li><li>s3:DeleteObject</li></ul></ul>                                                                                                                                 | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [bucket arn]</li><li>spec.builderConfig.cloudParameters.iam.aws.principal [role]</li></ul>                                                                                                                |                                           | [s3-role-exists-crud.yaml](../../../examples/iam/aws/s3-role-exists-crud.yaml)              |
| <h4>role-exists-crud-acl.s3.aws.iam.builder.upbound.io</h4>                     | s3       | role-exists-crud-acl                      | Create a CRUD policy with ACL perms and assigns it to the passed in role.                                                                                                                       | <ul><li>Allow<ul><li>s3:ListAllMyBuckets</li><li>s3:ListBucket</li><li>s3:GetBucketLocation</li><li>s3:PutObject</li><li>s3:PutObjectAcl</li><li>s3:GetObject</li><li>s3:GetObjectVersion</li><li>s3:GetObjectAcl</li><li>s3:DeleteObject</li></ul></ul>                                                     | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [bucket arn]</li><li>spec.builderConfig.cloudParameters.iam.aws.principal [role]</li></ul>                                                                                                                |                                           | [s3-role-exists-crud.yaml](../../../examples/iam/aws/s3-role-exists-crud.yaml)              |
| <h4>user-crud.s3.aws.iam.builder.upbound.io</h4>                                | s3       | user-crud                                 | Create crud policy for a bucket and assign it to a user.                                                                                                                                        | <ul><li>Allow<ul><li>s3:ListAllMyBuckets</li><li>s3:ListBucket</li><li>s3:GetBucketLocation</li><li>s3:PutObject</li><li>s3:GetObject</li><li>s3:DeleteObject</li></ul></ul>                                                                                                                                 | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [bucket arn]</li><li>spec.builderConfig.cloudParameters.iam.aws.principal [user]</li></ul>                                                                                                                |                                           | [s3-user-crud.yaml](../../../examples/iam/aws/s3-user-crud.yaml)                            |
| <h4>user-all-folders-crud.s3.aws.iam.builder.upbound.io</h4>                    | s3       | user-all-folders-crud                     | Create crud policy for all folders in a bucket and assign it to a user.                                                                                                                         | <ul><li>Allow<ul><li>s3:PutObject</li><li>s3:GetObject</li><li>s3:GetObjectVersion</li><li>s3:DeleteObject</li><li>s3:DeleteObjectVersion</li></ul></ul>                                                                                                                                                     | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [bucket arn]</li><li>spec.builderConfig.cloudParameters.iam.aws.principal [user]</li></ul>                                                                                                                |                                           | [s3-user-folder-crud.yaml](../../../examples/iam/aws/s3-user-all-folders-crud.yaml)         |
| <h4>role-new-full-access.lambda.aws.iam.builder.upbound.io</h4>                 | lambda   | basic-managed                             | Create basic lambda policy using AWS managed policy AWSLambdaFullAccess                                                                                                                         | <ul><li>Managed<ul><li>AWSLambda_FullAccess</li></ul></ul>                                                                                                                                                                                                                                                   |                                                                                                                                                                                                                                                                          |                                           |                                                                                             |


### Resource-Based

| Composition                                                               | Service | Config                             | Description                                                                     | Policy                                                                                                                                                                                                                                                                                                                                           | Required Inputs                                                                                                                                                        | Outputs                                   | Example                                                                                                     |
|---------------------------------------------------------------------------|---------|------------------------------------|---------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------|-------------------------------------------------------------------------------------------------------------|
| <h4>bucket-policy-cloudfront-oai.s3.aws.iam.builder.upbound.io</h4>       | s3      | bucket-policy-cloudfront-oai       | Create basic eks policy for api server and nodes assigned to cluster name given | <ul><li>Allow<ul><li>s3:GetObject</li></ul></ul>                                                                                                                                                                                                                                                                                                 | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [bucket arn]</li><li>spec.builderConfig.cloudParameters.iam.aws.principal [cloudfront origin arn]</li></ul> |                                           | [s3-bucket-policy-cloudfront-oai.yaml](../../../examples/iam/aws/s3-bucket-policy-cloudfront-oai.yaml)      |
| <h4>bucket-policy-crud-principal.s3.aws.iam.builder.upbound.io</h4>       | s3      | bucket-policy-crud-principal       | Create a CRUD bucket policy for a single principal                              | <ul><li>Allow<ul><li>s3:GetObject</li><li>s3:ListBucket</li><li>s3:GetBucketLocation</li><li>s3:GetObjectVersion</li><li>s3:PutObject</li><li>s3:PutObjectAcl</li><li>s3:GetLifecycleConfiguration</li><li>s3:PutLifecycleConfiguration</li><li>s3:DeleteObject</li></ul></ul>                                                                   | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [bucket arn]</li><li>spec.builderConfig.cloudParameters.iam.aws.principal [user arn]</li></ul>              |                                           | [s3-bucket-policy-crud-principal.yaml](../../../examples/iam/aws/s3-bucket-policy-crud-principal.yaml)      |
| <h4>bucket-policy-full-access.s3.aws.iam.builder.upbound.io</h4>          | s3      | bucket-policy-full-access          | Create a full access bucket policy for all users                                | <ul><li>Allow<ul><li>s3:GetObject</li><li>s3:GetObjectAcl</li><li>s3:PutObject</li><li>s3:PutObjectAcl</li><li>s3:DeleteObject</li><li>s3:DeleteObjectTagging</li><li>s3:DeleteObjectVersionTagging</li><li>s3:GetObjectTagging</li><li>s3:GetObjectVersionTagging</li><li>s3:PutObjectTagging</li><li>s3:PutObjectVersionTagging</li></ul></ul> | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [bucket arn]</li></ul>                                                                                    |                                           | [s3-bucket-policy-full-access.yaml](../../../examples/iam/aws/s3-bucket-policy-full-access.yaml)            |
| <h4>bucket-policy-public-read.s3.aws.iam.builder.upbound.io</h4>          | s3      | bucket-policy-public-read          | Create a public read bucket policy                                              | <ul><li>Allow<ul><li>s3:GetObject</li><li>s3:GetObjectVersion</li></ul></ul>                                                                                                                                                                                                                                                                     | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [bucket arn]</li></ul>                                                                                    |                                           | [s3-bucket-policy-public-read.yaml](../../../examples/iam/aws/s3-bucket-policy-public-read.yaml)            |
| <h4>bucket-policy-put-single-principal.s3.aws.iam.builder.upbound.io</h4> | s3      | bucket-policy-put-single-principal | Create a put bucket policy for a single principal                               | <ul><li>Allow<ul><li>s3:PutObject</li><li>s3:GetObjectAcl</li></ul></ul>                                                                                                                                                                                                                                                                         | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [bucket arn]</li><li>spec.builderConfig.cloudParameters.iam.aws.principal [user arn]</li></ul>              |                                           | [s3-bucket-policy-put-single-principal.yaml](../../../examples/iam/aws/s3-bucket-put-single-principal.yaml) |
| <h4>bucket-policy-require-mfa.s3.aws.iam.builder.upbound.io</h4>          | s3      | bucket-policy-require-mfa          | Create a bucket policy to require multi-factor-auth                             | <ul><li>Deny<ul><li>s3:*</li></ul></ul><ul><li>Condition<ul><li>aws:MultiFactorAuthAge: true </li></ul></ul>                                                                                                                                                                                                                                     | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [bucket arn]</li></ul>                                                                                    |                                           | [s3-bucket-policy-require-mfa.yaml](../../../examples/iam/aws/s3-bucket-require-mfa.yaml)                   |
| <h4>poller-policy-url-by-name.sqs.aws.iam.builder.upbound.io</h4>         | sqs     | poller-policy-url-by-name          | Create a poller policy for a url by name                                        | <ul><li>Allow<ul><li>sqs:ChangeMessageVisibility</li><li>sqs:ChangeMessageVisibilityBatch</li><li>sqs:DeleteMessage</li><li>sqs:DeleteMessageBatch</li><li>sqs:GetQueueAttributes</li><li>sqs:ReceiveMessage</li></ul></ul>                                                                                                                      | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [queue url arn]</li></ul>                                                                                 |                                           | [sqs-poller-policy-url-by-name.yaml](../../../examples/iam/aws/sqs-poller-policy-url-by-name.yaml)          |
| <h4>poller-policy-url-by-selector.sqs.aws.iam.builder.upbound.io</h4>     | sqs     | poller-policy-url-by-selector      | Create a poller policy for a url by selector                                    | <ul><li>Allow<ul><li>sqs:ChangeMessageVisibility</li><li>sqs:ChangeMessageVisibilityBatch</li><li>sqs:DeleteMessage</li><li>sqs:DeleteMessageBatch</li><li>sqs:GetQueueAttributes</li><li>sqs:ReceiveMessage</li></ul></ul>                                                                                                                      | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [queue url arn]</li></ul>                                                                                 |                                           | [sqs-poller-policy-url-by-selector.yaml](../../../examples/iam/aws/sqs-poller-policy-url-by-selector.yaml)  |

### Resource-Level-Based

| Composition                                             | Service  | Config     | Description                                        | Policy                                                                                                                                       | Required Inputs                                                                              | Outputs                                   | Example                                                                                                |
|---------------------------------------------------------|----------|------------|----------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------|-------------------------------------------|--------------------------------------------------------------------------------------------------------|
| <h4>manage.dynamodb.aws.iam.builder.upbound.io</h4>     | dynamodb | manage     | Create policy to be able to manage dynamodb table  | <ul><li>Allow<ul><li>dynamodb:ListTables</li><li>dynamodb:ListStreams</li><li>dynamodb:ListGlobalTables</li></ul></ul>                       | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [dynamodb table arn]</li></ul>  |                                           | [dynamodb-resource-level-generic.yaml](../../../examples/iam/aws/dynamodb-resource-level-generic.yaml) |
| <h4>read-only.dynamodb.aws.iam.builder.upbound.io</h4>  | dynamodb | read-only  | Create policy to be able to read a dynamodb table  | <ul><li>Allow<ul><li>dynamodb:Query</li><li>dynamodb:BatchGetItem</li><li>dynamodb:GetItem</li><li>dynamodb:GetScan</li></ul></ul>           | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [dynamodb table arn]</li></ul>  |                                           | [dynamodb-resource-level-generic.yaml](../../../examples/iam/aws/dynamodb-resource-level-generic.yaml) |
| <h4>write-only.dynamodb.aws.iam.builder.upbound.io,.h4> | dynamodb | write-only | Create policy to be able to write a dynamodb table | <ul><li>Allow<ul><li>dynamodb:DeleteItem</li><li>dynamodb:BatchWriteItem</li><li>dynamodb:PutItem</li><li>dynamodb:UpdateItem</li></ul></ul> | <ul><li>spec.builderConfig.cloudParameters.iam.aws.resourceArn [dynamodb table arn]</li></ul>  |                                           | [dynamodb-resource-level-generic.yaml](../../../examples/iam/aws/dynamodb-resource-level-generic.yaml) |
